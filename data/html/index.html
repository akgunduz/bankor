<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    />
    <style>
      body {
        background-color: #bababa;
        font-family: "Lato", sans-serif;
      }

      /* Fixed sidenav, full height */
      .sidenav {
        height: 100%;
        width: 12rem;
        position: fixed;
        z-index: auto;
        top: 0;
        left: 0;
        background-color: #222;
        overflow-x: hidden;
        padding-top: 2rem;
      }

      /* Style the sidenav links and the dropdown button */
      .sidenav a,
      .dropdown-btn {
        padding: 0.5rem 1rem 0.5rem 1rem;
        text-decoration: none;
        font-size: 1.4rem;
        color: #818181;
        display: block;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
        outline: none;
      }

      /* On mouse-over */
      .sidenav a:hover,
      .dropdown-btn:hover {
        color: #f1f1f1;
      }

      /* Add an active class to the active dropdown button */
      .sidebar_btn_active {
        background-color: green;
        color: white;
      }

      .item-valid {
        background-color: #00c000;
      }

      /* Optional: Style the caret down icon */
      .fa-caret-down {
        padding-top: 0.2rem;
        float: right;
        padding-right: 0.5rem;
      }

      /* Dropdown container (hidden by default). Optional: add a lighter background color and some left padding to change the design of the dropdown content */
      .dropdown-container {
        display: none;
        background-color: #262626;
        padding-left: 8px;
      }

      /* Main content */
      .component-block {
        margin-left: 12rem;
        text-align: center;
        font-size: 1rem;
        padding: 1rem;
        background-color: #bababa;
      }

      .standard-container {
        width: 100%;
        padding: 1rem;
      }

      .btn-full-width {
        width: 100%;
        height: 6rem;
        font-size: 2rem;
        background-color: #90e3ff;
        margin-bottom: 2rem;
      }

      .dual-tables-container {
        width: 100%;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
      }

      .table-wide {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
      }

      td,
      th {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 0.5rem;
      }

      /* tr:nth-child(even) {
        background-color: #dddddd;
      } */

      .single-table-container {
        width: 49%;
      }
    </style>
  </head>
  <body onload="onLoad()">
    <div class="sidenav">
      <a onclick="onDistClick()"> Distributor</a>
      <button class="dropdown-btn">
        Collectors
        <i class="fa fa-caret-down"></i>
      </button>
      <div id="sidebar-coll-list" class="dropdown-container"></div>
      <button class="dropdown-btn">
        Nodes
        <i class="fa fa-caret-down"></i>
      </button>
      <div id="sidebar-node-list" class="dropdown-container"></div>
    </div>

    <div class="component-block" hidden>
      <h1>Debug</h1>
      <p id="testField">Test</p>
    </div>

    <div id="distributor-block" class="component-block" style="display: block;">
      <h1>Distributor</h1>
      <button
        type="button"
        class="button btn-full-width"
        onclick="onDistPoll()"
      >
        Poll
      </button>
      <div class="dual-tables-container">
        <div class="single-table-container">
          <h3>Collectors</h3>
          <table id="dist-colls-table" class="table-wide">
            <thead>
              <tr>
                <th>ID</th>
                <th>State</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="single-table-container">
          <h3>Nodes</h3>
          <table id="dist-nodes-table" class="table-wide">
            <thead>
              <tr>
                <th>ID</th>
                <th>State</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="collector-block" class="component-block" style="display: none;">
      <h1 id="coll-header">Collector</h1>
      <div id="coll-area" class="dual-tables-container">
        <div id="coll-file" class="single-table-container">
          <button
            type="button"
            class="button btn-full-width"
            onclick="onCollLoadJob()"
          >
            Load Job
          </button>
          <h3 id=coll-job-name style="text-align: left; margin-bottom: 1rem;">Job :</h3>
          <table id="coll-file-table" class="table-wide">
            <thead>
              <tr>
                <th>Job Files</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="coll-process" class="single-table-container">
          <button
            type="button"
            class="button btn-full-width"
            onclick="onCollProcess()"
          >
            Process
          </button>
          <h3 style="text-align: left; margin-bottom: 1rem;">Processes :</h3>
          <table id="coll-process-table" class="table-wide">
            <colgroup>
              <col span="1" style="width: 10%;" />
              <col span="1" style="width: 70%;" />
              <col span="1" style="width: 20%;" />
            </colgroup>
            <thead>
              <tr>
                <th>ID</th>
                <th>Command</th>
                <th>Assigned Node</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="node-block" class="component-block" style="display: none;">
      <h1 id="node-header">Node</h1>
      <div id="node-area" class="dual-tables-container">
        <h3>State :</h3>
        <h3 id="node-state">IDLE</h3>
      </div>
      <div class="standard-container">
        <h3 style="text-align: left; margin-bottom: 1rem;">Processes :</h3>
        <table id="node-process-table" class="table-wide">
          <colgroup>
            <col span="1" style="width: 10%;" />
            <col span="1" style="width: 10%;" />
            <col span="1" style="width: 20%;" />
            <col span="1" style="width: 60%;" />
          </colgroup>
          <thead>
            <tr>
              <th>ID</th>
              <th>Collector</th>
              <th>Job</th>
              <th>Process</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <script>
      var DISTRIBUTOR = 0x0;
      var COLLECTOR = 0x1;
      var NODE = 0x2;

      var PORT = "8081";
      var HOSTING = "http://localhost:" + PORT;
      var REST_URI = HOSTING + "/rest";
      var REST_STATE = "/state";

      var REST_DIST_URI = REST_URI + "/dist";
      var REST_DIST_POLL = "/poll";

      var REST_COLL_URI = REST_URI + "/coll";
      var REST_COLL_LOAD = "/load";
      var REST_COLL_PROCESS = "/process";

      var REST_NODE_URI = REST_URI + "/node";

      var WS_URI = "ws://localhost:" + PORT + "/ws";

      var COLL_STATES = ["START", "IDLE", "BUSY"];
      var NODE_STATES = ["START", "IDLE", "PREBUSY", "BUSY"];

      var PROCESS_STATE_DEPENDENT = 0;
      var PROCESS_STATE_READY = 1;
      var PROCESS_STATE_STARTED = 2;
      var PROCESS_STATE_ENDED = 3;

      var currentPage = {
        type: DISTRIBUTOR,
        id: 0,
        set(_type, _id) {
          this.type = _type;
          this.id = _id;
          let distPage = document.getElementById("distributor-block");
          let collPage = document.getElementById("collector-block");
          let nodePage = document.getElementById("node-block");

          switch (this.type) {
            case DISTRIBUTOR:
              distPage.style.display = "block";
              collPage.style.display = "none";
              nodePage.style.display = "none";
              onDistState();
              break;
            case COLLECTOR:
              distPage.style.display = "none";
              collPage.style.display = "block";
              nodePage.style.display = "none";
              document.getElementById("coll-header").innerHTML =
                "Collector [" + this.id + "]";
              onCollState(this.id);
              break;
            case NODE:
              distPage.style.display = "none";
              collPage.style.display = "none";
              nodePage.style.display = "block";
              document.getElementById("node-header").innerHTML =
                "Node [" + this.id + "]";
              onNodeState(this.id);
              break;
          }
        },
      };

      var dropdown = document.getElementsByClassName("dropdown-btn");
      for (var i = 0; i < dropdown.length; i++) {
        dropdown[i].addEventListener("click", function () {
          this.classList.toggle("sidebar_btn_active");
          var dropdownContent = this.nextElementSibling;
          if (dropdownContent.style.display === "block") {
            dropdownContent.style.display = "none";
          } else {
            dropdownContent.style.display = "block";
          }
        });
      }

      function onDistClick() {
        currentPage.set(DISTRIBUTOR, this.id);
      }

      function onCollClick() {
        currentPage.set(COLLECTOR, this.id);
      }

      function onNodeClick() {
        currentPage.set(NODE, this.id);
      }

      function onDistState() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var data = JSON.parse(this.responseText);
            onDistUpdateCollList(data);
            onDistUpdateNodeList(data);
          }
        };
        xhttp.open("GET", REST_DIST_URI + REST_STATE, true);
        xhttp.send();
      }

      function onDistPoll() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            //response is async, will be get via WS
          }
        };
        xhttp.open("GET", REST_DIST_URI + REST_DIST_POLL, true);
        xhttp.send();
      }

      function onDistUpdateCollList(data) {
        let table = document
          .getElementById("dist-colls-table")
          .getElementsByTagName("tbody")[0];
        table.innerHTML = "";
        let side = document.getElementById("sidebar-coll-list");
        side.innerHTML = "";

        for (var collitem of data.collList) {
          let newRow = table.insertRow();
          newRow.insertCell().innerHTML = collitem.collectorID;
          newRow.insertCell().innerHTML = COLL_STATES[collitem.state];

          let component = document.createElement("a");
          component.onclick = onCollClick;
          component.id = collitem.collectorID;
          component.appendChild(
            document.createTextNode("Collector " + component.id)
          );
          side.appendChild(component);
        }
      }

      function onDistUpdateNodeList(data) {
        let table = document
          .getElementById("dist-nodes-table")
          .getElementsByTagName("tbody")[0];
        table.innerHTML = "";
        let side = document.getElementById("sidebar-node-list");
        side.innerHTML = "";

        for (var nodeitem of data.nodeList) {
          let newRow = table.insertRow();
          newRow.insertCell().innerHTML = nodeitem.nodeID;
          newRow.insertCell().innerHTML = NODE_STATES[nodeitem.state];

          let component = document.createElement("a");
          component.onclick = onNodeClick;
          component.id = nodeitem.nodeID;
          component.appendChild(
            document.createTextNode("Node " + component.id)
          );
          side.appendChild(component);
        }
      }

      function onCollState() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var data = JSON.parse(this.responseText);
            onCollUpdateFileList(data);
            onCollUpdateProcessList(data);
          }
        };
        xhttp.open(
          "GET",
          REST_COLL_URI + "/" + currentPage.id + REST_STATE,
          true
        );
        xhttp.send();
      }

      function onCollLoadJob() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            //response is async, will be get via WS
          }
        };
        xhttp.open(
          "GET",
          REST_COLL_URI + "/" + currentPage.id + REST_COLL_LOAD,
          true
        );
        xhttp.send();
      }

      function onCollProcess(collID) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            testField.innerHTML = this.responseText;
          }
        };
        xhttp.open(
          "GET",
          REST_COLL_URI + "/" + currentPage.id + REST_COLL_PROCESS,
          true
        );
        xhttp.send();
      }

      function onCollUpdateFileList(data) {
        let table = document
          .getElementById("coll-file-table")
          .getElementsByTagName("tbody")[0];
        table.innerHTML = "";

        document.getElementById("coll-job-name").innerHTML =
          "Job : " + data.jobName;

        for (var fileitem of data.fileList) {
          let newRow = table.insertRow();
          let newcell = newRow.insertCell();
          newcell.innerHTML = fileitem.file;
          if (fileitem.validity) {
            newcell.style.backgroundColor = "#00C000";
          }
        }
      }

      function onCollUpdateProcessList(data) {
        let table = document
          .getElementById("coll-process-table")
          .getElementsByTagName("tbody")[0];
        table.innerHTML = "";

        for (var processitem of data.processList) {
          let newRow = table.insertRow();
          newRow.insertCell().innerHTML = processitem.id;
          newRow.insertCell().innerHTML = processitem.process;
          newRow.insertCell().innerHTML =
            processitem.node != 0 ? processitem.node : "Not Assigned";

          switch (processitem.state) {
            case PROCESS_STATE_DEPENDENT:
              if (processitem.validity) {
                newRow.style.backgroundColor = "#00C000";
              }
              break;
            case PROCESS_STATE_READY:
              newcell.style.backgroundColor = "#000080";
              break;
            case PROCESS_STATE_STARTED:
              newRow.style.backgroundColor = "#800080";
              break;
            case PROCESS_STATE_ENDED:
              newRow.style.backgroundColor = "#C0C0C0";
              break;
          }
        }
      }

      function onNodeState() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var data = JSON.parse(this.responseText);
            onNodeUpdateState(data);
            onNodeUpdateProcessList(data);
          }
        };
        xhttp.open(
          "GET",
          REST_NODE_URI + "/" + currentPage.id + REST_STATE,
          true
        );
        xhttp.send();
      }

      function onNodeUpdateState(data) {
        document.getElementById("node-state").innerHTML =
          NODE_STATES[data.state];
      }

      function onNodeUpdateProcessList(data) {
        let table = document
          .getElementById("node-process-table")
          .getElementsByTagName("tbody")[0];
        table.innerHTML = "";

        for (var processitem of data.processList) {
          let newRow = table.insertRow();
          newRow.insertCell().innerHTML = processitem.processID;
          newRow.insertCell().innerHTML = processitem.collectorID;
          newRow.insertCell().innerHTML = processitem.jobID;
          newRow.insertCell().innerHTML = processitem.process;
        }
      }

      function onLoad() {
        var wsConn = new WebSocket(WS_URI);
        currentPage.set(DISTRIBUTOR, this.id);
        wsConn.onmessage = function (info) {
          let component = parseInt(info.data, 10);
          switch (component) {
            case DISTRIBUTOR:
              onDistState();
              break;
            case COLLECTOR:
              onCollState();
              break;
            case NODE:
              onNodeState();
              break;
          }
        };
        wsConn.onerror = function (error) {
          //   alert("Websocket error");
          wsConn.close();
        };
        console.log(wsConn);
      }
    </script>
  </body>
</html>
